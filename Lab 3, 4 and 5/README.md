# Mobile IP

## Implementation

To migrate to a new network the Mobile Node (MN) sends a `RegistrationRequest` packet to the Foreign
Agent (FA), the router in the new network. Upon receiving this packet the FA assigns an IP address,
the care-of address (CoA), to the MN and then relays this information to the Home Agent (HA) of the
MN. Upon receiving this packet the HA creates a new binding to map the care-of address to the
original address, the home address (HoA), of the MN. Finally, whenever a correspondent node (CN)
sends a packet to the HoA of the MN the HA intercepts it and tunnels it to the CoA of the MN.

## Example

To showcase this functionality we came up with the following example:

Given this network topology:

<p align="center">
  <img alt="before.png" src="https://user-images.githubusercontent.com/5018213/37641525-5fb614be-2c1a-11e8-9ba9-cd24dfb2db3d.png">
</p>

We wrote a program that performed the following actions:

``` java
// A and C send two packets to B; B send two packets to A
// The first packets will be sent *before* B migrates
// The seconds packets will be sent *after* B migrates
A.StartSending(B.getAddr().networkId(), B.getAddr().nodeId(), 2, 40, 0, 0);
C.StartSending(B.getAddr().networkId(), B.getAddr().nodeId(), 2, 40, 2, 10);
B.StartSending(A.getAddr().networkId(), A.getAddr().nodeId(), 2, 40, 4, 20);

// migrate B to network 2
B.send(R2, new RegistrationRequest(R1), 30);
```

Nodes A and C will sent two packets (40 ms apart) to node B, and node B will sent two packets (40 ms
apart) to node A. After the first three packets are sent the node B will migrate from network I to
network II. After the migration the second three packets will be sent.

The network topology after the migration becomes:

<p align="center">
  <img alt="after.png" src="https://user-images.githubusercontent.com/5018213/37641538-67589d22-2c1a-11e8-9e86-9d60897b5d6d.png">
</p>

Seven events occurred in that program. These are shown below accompanied with their respective logs
generated by the program:

- At t=0 A (1.1) sends a packet to C (1.2)

``` text
Node 1.1 sent message with seq: 0 at time 0.0
Link recv msg, passes it through
Router 1 handles packet with seq: 0 from node: 1.1
Router sends to node: 1.2
Link recv msg, passes it through
Node 1.2 receives message with seq: 0 at time 0.0
```

- At t=10 B (2.3) sends a packet to C (1.2)

``` text
Node 2.3 sent message with seq: 2 at time 10.0
Link recv msg, passes it through
Router 2 handles packet with seq: 2 from node: 2.3
Router sends to node: 1.2
Link recv msg, passes it through
Router 1 handles packet with seq: 2 from node: 2.3
Router sends to node: 1.2
Link recv msg, passes it through
Node 1.2 receives message with seq: 2 at time 10.0
```

- At t=20 C (1.2) sends a packet to A (1.1)

``` text
Node 1.2 sent message with seq: 4 at time 20.0
Link recv msg, passes it through
Router 1 handles packet with seq: 4 from node: 1.2
Router sends to node: 1.1
Link recv msg, passes it through
Node 1.1 receives message with seq: 4 at time 20.0
```

- At t=30 B migrates to network II and receives the care-of address 2.0

``` text
Node(1.2) is migrating to network 2
Node with home address 1.2 has been assigned the care-of address 2.0
```

- At t=40 A (1.1) sends a packet to C's home address (1.2) -- note that the HA (R1) tunnels the packet

``` text
Node 1.1 sent message with seq: 1 at time 40.0
Link recv msg, passes it through
HA: Tunneling message from 1.2 to 2.0
Router 1 handles packet with seq: 1 from node: 1.1
Router sends to node: 2.0
Link recv msg, passes it through
Node 2.0 receives message with seq: 1 at time 40.0
```

- At t=50 B (2.3) sends a packet to C's home address (1.2) -- note that the HA (R1) tunnels the packet

``` text
Node 2.3 sent message with seq: 3 at time 50.0
Link recv msg, passes it through
Router 2 handles packet with seq: 3 from node: 2.3
Router sends to node: 1.2
Link recv msg, passes it through
HA: Tunneling message from 1.2 to 2.0
Router 1 handles packet with seq: 3 from node: 2.3
Router sends to node: 2.0
Link recv msg, passes it through
Node 2.0 receives message with seq: 3 at time 50.0
```

- At t=60 C (2.0) sends a packet to A (1.1)

``` text
Node 2.0 sent message with seq: 5 at time 60.0
Link recv msg, passes it through
Router 2 handles packet with seq: 5 from node: 2.0
Router sends to node: 1.1
Link recv msg, passes it through
Router 1 handles packet with seq: 5 from node: 2.0
Router sends to node: 1.1
Link recv msg, passes it through
Node 1.1 receives message with seq: 5 at time 60.0
```
